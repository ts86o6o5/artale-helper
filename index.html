<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·è»¸æˆæœ¬ - ç·šä¸Šç©©å®šç‰ˆ</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; padding: 10px; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .summary { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .card { flex: 1; min-width: 150px; padding: 12px; border-radius: 8px; color: white; text-align: center; }
        .card b { font-size: 1.2em; display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: center; }
        th { background: #1e293b; color: white; position: sticky; top: 0; }
        input { width: 90%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; }
        .btn { cursor: pointer; border: none; border-radius: 4px; padding: 6px 12px; font-weight: bold; }
        .btn-search { background: #3b82f6; color: white; }
        .btn-del { background: #ef4444; color: white; width: 30px; }
        .btn-add { background: #10b981; color: white; margin-top: 15px; }
        .btn-util { background: #64748b; color: white; font-size: 12px; margin-left: 5px; }
        .pos { color: #10b981; font-weight: bold; }
        .neg { color: #ef4444; font-weight: bold; }
        .active-row { background-color: #e0f2fe !important; }
        @media (max-width: 600px) { input { font-size: 12px; } .btn { padding: 4px 8px; } }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin:0;">ğŸ“Š å·è»¸æˆæœ¬</h2>
        <div>
            <button class="btn btn-util" onclick="exportData()">åŒ¯å‡ºå‚™ä»½</button>
            <button class="btn btn-util" onclick="importData()">åŒ¯å…¥æ•¸æ“š</button>
        </div>
    </div>
    <br>
    <div class="summary">
        <div class="card" style="background:#64748b">ç¸½æˆæœ¬<b id="t-cost">0</b></div>
        <div class="card" style="background:#10b981">é æœŸåˆ©æ½¤<b id="t-profit">0</b></div>
        <div class="card" style="background:#3b82f6">é æœŸç¸½æ”¶å…¥<b id="t-revenue">0</b></div>
        <div class="card" style="background:#f43f5e">ç²åˆ©ç‡<b id="t-margin">0%</b></div>
    </div>

    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>é …ç›®åç¨±</th>
                    <th>æˆæœ¬</th>
                    <th>æ•¸é‡</th>
                    <th>ç›®å‰å¸‚åƒ¹</th>
                    <th>åˆ©æ½¤</th>
                    <th>åŠŸèƒ½</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>
    <button class="btn btn-add" onclick="addRow()">+ æ–°å¢é …ç›®</button>
</div>

<script>
    const INITIAL_DATA = [{"n":"å¼©æ”»æ“Šè©›å’’å·è»¸30%","c":380,"a":2,"m":750},{"n":"å¼©æ”»æ“Šè©›å’’å·è»¸30%","c":389,"a":1,"m":750},{"n":"å¼©æ”»æ“Šè©›å’’å·è»¸30%","c":390,"a":2,"m":750},{"n":"è…°å¸¶æ•æ·å·è»¸60%","c":340,"a":1,"m":900},{"n":"è…°å¸¶åŠ›é‡å·è»¸60%","c":580,"a":1,"m":800},{"n":"å¢œé£¾æ•æ·å·è»¸30%","c":570,"a":1,"m":880},{"n":"å¢œé£¾æ•æ·å·è»¸30%","c":600,"a":4,"m":880},{"n":"å¢œé£¾æ™ºåŠ›å·è»¸30%","c":285,"a":1,"m":395},{"n":"å¢œé£¾åŠ›é‡å·è»¸30%","c":680,"a":2,"m":1150},{"n":"å¢œé£¾åŠ›é‡å·è»¸30%","c":720,"a":3,"m":1150},{"n":"å¢œé£¾åŠ›é‡å·è»¸30%","c":750,"a":5,"m":1150},{"n":"å¢œé£¾åŠ›é‡å·è»¸60%","c":410,"a":1,"m":720},{"n":"å¼©æ”»æ“Šè©›å’’å·è»¸30%","c":450,"a":3,"m":750},{"n":"å¼©æ”»æ“Šè©›å’’å·è»¸30%","c":445,"a":1,"m":750},{"n":"é ­ç›”æ•æ·å·è»¸60%","c":145,"a":5,"m":140},{"n":"é ­ç›”æ•æ·å·è»¸60%","c":150,"a":35,"m":140}];

    window.onload = () => {
        const saved = localStorage.getItem('artale_online_v1');
        let data = saved ? JSON.parse(saved) : INITIAL_DATA;
        
        // æ–°å¢ï¼šæŒ‰ç…§åç¨±æ’åº (localeCompare å¯æ­£ç¢ºè™•ç†ä¸­æ–‡)
        data.sort((a, b) => a.n.localeCompare(b.n, 'zh-Hant'));
        
        data.forEach(d => addRow(d));
        calc();
    };

    function addRow(item = { n: '', c: 0, a: 0, m: 0 }) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="${item.n}" class="in-n" oninput="calc()"></td>
            <td><input type="number" value="${item.c}" class="in-c" oninput="calc()"></td>
            <td><input type="number" value="${item.a}" class="in-a" oninput="calc()"></td>
            <td><input type="number" value="${item.m}" class="in-m" oninput="calc()" style="background:#fffbeb; font-weight:bold;"></td>
            <td class="row-p">0</td>
            <td>
                <button class="btn btn-search" onclick="doSearch(this)">æŸ¥åƒ¹</button>
                <button class="btn btn-del" onclick="delRow(this)">X</button>
            </td>
        `;
        document.getElementById('tbody').appendChild(tr);
        calc();
    }

    function doSearch(btn) {
        const row = btn.closest('tr');
        const name = row.querySelector('.in-n').value;
        const priceInput = row.querySelector('.in-m');
        if (!name) return;
        navigator.clipboard.writeText(name);
        window.open(`https://artale-market.org/transaction?itemName=${encodeURIComponent(name)}&transactionType=sell&isActive=true&currency=snow&timeRange=24`, "_blank");
        document.querySelectorAll('tr').forEach(r => r.classList.remove('active-row'));
        row.classList.add('active-row');
        setTimeout(() => { priceInput.focus(); priceInput.select(); }, 150);
    }

    function delRow(btn) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { btn.closest('tr').remove(); calc(); } }

    function calc() {
        let tC = 0, tP = 0, tR = 0, storage = [];
        document.querySelectorAll('#tbody tr').forEach(r => {
            const n = r.querySelector('.in-n').value;
            const c = parseFloat(r.querySelector('.in-c').value) || 0;
            const a = parseFloat(r.querySelector('.in-a').value) || 0;
            const m = parseFloat(r.querySelector('.in-m').value) || 0;
            const costTotal = c * a;
            const revenueTotal = m * a;
            const profit = revenueTotal - costTotal;
            
            r.querySelector('.row-p').innerText = profit.toLocaleString();
            r.querySelector('.row-p').className = "row-p " + (profit >= 0 ? "pos" : "neg");
            
            tC += costTotal; 
            tP += profit;
            tR += revenueTotal;
            storage.push({n, c, a, m});
        });
        document.getElementById('t-cost').innerText = tC.toLocaleString();
        document.getElementById('t-revenue').innerText = tR.toLocaleString();
        document.getElementById('t-profit').innerText = tP.toLocaleString();
        document.getElementById('t-margin').innerText = tC > 0 ? ((tP / tC) * 100).toFixed(2) + "%" : "0%";
        localStorage.setItem('artale_online_v1', JSON.stringify(storage));
    }

    function exportData() {
        const data = localStorage.getItem('artale_online_v1');
        const blob = new Blob([data], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `artale_backup_${new Date().toLocaleDateString()}.json`;
        a.click();
    }

    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = event => {
                localStorage.setItem('artale_online_v1', event.target.result);
                location.reload();
            };
            reader.readAsText(file);
        };
        input.click();
    }
</script>
</body>
</html>